#!/bin/sh -e

VERSION=0.1

die() {
	echo "Error: $*" >&2
	exit 1
}

usage() {
	cat <<EOF
Usage: ${0##*/} [OPTIONS] [RUNLEVEL]

Options:
 -D or --debug          Turn on debug mode.
 -q or --quiet          Turn off verbosity.
 -v or --verbose        Turn on verbosity.
 -h or --help           Display this message.
 -V or --version        Display the version.
EOF
}

. /etc/init.d/mount-linuxfs
. /etc/init.d/mdev
. /etc/init.d/console
. /etc/init.d/oops

initargs="$*"
PERSISTENTDIR=/media/persistent
OVERLAYDIR=/media/root-overlay
while [ $# -ne 0 ]; do
	if [ "$1" = -h ] || [ "$1" = --help ]; then
		usage
		exit 0
	elif [ "$1" = "-V" ] || [ "$1" = "--version" ] ; then
		echo $VERSION
		exit 0
	elif [ "$1" = "-c" ] || [ "$1" = "--console" ] ; then
		shift
		console=$1
	elif [ "$1" = -D ] || [ "$1" = debug ]; then
		export DEBUG=1
	elif [ "$1" = -v ] || [ "$1" = verbose ]; then
		export VERBOSE=1
	elif [ "$1" = -q ] || [ "$1" = quiet ]; then
		export QUIET=1
	elif echo "$1" | grep -qE "^[a-zA-Z0-9_]+="; then
		var=$(echo $1 | cut -d= -f1)
		val=$(echo $1 | cut -d= -f2)
		export $var=$val
	else
		usage
		die "Too many arguments!"
	fi
	shift
done

echo "Mounting persistent directory to $PERSISTENTDIR..."
MOUNTDIR=$PERSISTENTDIR MOUNTOPTS=$PERSISTENTOPTS \
/etc/init.d/mount-persistent start


echo "Mounting overlay directory to $CHROOTDIR..."
MOUNTDIR=$CHROOTDIR PERSISTENTDIR=$PERSISTENTDIR MOUNTOPTS=$OVERLAYOPTS \
/etc/init.d/mount-overlay start

for init in /sbin/init /etc/init /bin/init /bin/sh; do
	[ -e $CHROOTDIR/$init ] && break
done

install -d $CHROOTDIR
chrootdir=$OVERLAYDIR
echo "Installing chroot to $CHROOTDIR..."
for dir in /dev /dev/pts /sys /proc; do
	mount -o bind $dir $CHROOTDIR$dir
done

echo "Chrooting to $chrootdir..."
chroot=$CHROOTDIR exec chroot $CHROOTDIR $init $initargs

echo "Oops... ${0##*/} is about to exit!" >&2
exit 1
